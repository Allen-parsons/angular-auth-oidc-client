# Version 11 to 12

Version 12 introduces a big new feature with supporting multiple configurations and with that multiple identity provider. With that the configuration and the interface for the users changes.

We also introduced an easier way of configuring the lib from the start to align in best practices.

## Bootstrapping the lib

To make the configuration at the start easier and to be able to pass multiple configs we re-wrote the bootstrapping process of the lib.

### Static configuration

Old:

```ts
import { HttpClientModule } from '@angular/common/http';
import { APP_INITIALIZER, NgModule } from '@angular/core';
import { AuthModule, LogLevel, OidcConfigService } from 'angular-auth-oidc-client';
// ...

export function configureAuth(oidcConfigService: OidcConfigService) {
  return () =>
    oidcConfigService.withConfig({
      /* your config here */
    });
}

@NgModule({
  // ...
  imports: [
    // ...
    AuthModule.forRoot(),
  ],
  providers: [
    OidcConfigService,
    {
      provide: APP_INITIALIZER,
      useFactory: configureAuth,
      deps: [OidcConfigService],
      multi: true,
    },
  ],
  // ...
})
export class AppModule {}
```

New:

```typescript
import { HttpClientModule } from '@angular/common/http';
import { NgModule } from '@angular/core';
import { AuthModule, LogLevel } from 'angular-auth-oidc-client';
// ...

@NgModule({
  // ...
  imports: [
    // ...
    AuthModule.forRoot({
      config: {
        /* your config here */
      },
    }),
  ],
  // ...
})
export class AppModule {}
```

### Loading config from endpoint (http)

Old

```ts
import { HttpClient } from '@angular/common/http';
import { APP_INITIALIZER, NgModule } from '@angular/core';
import { AuthModule, OidcConfigService, OidcSecurityService } from 'angular-auth-oidc-client';
import { map, switchMap } from 'rxjs/operators';

export function configureAuth(oidcConfigService: OidcConfigService, httpClient: HttpClient) {
  const setupAction$ = httpClient.get<any>(`https://...`).pipe(
    map((customConfig) => {
      return {
        /* your config mapping here */
      };
    }),
    switchMap((config) => oidcConfigService.withConfig(config))
  );

  return () => setupAction$.toPromise();
}

@NgModule({
  imports: [AuthModule.forRoot()],
  providers: [
    OidcSecurityService,
    OidcConfigService,
    {
      provide: APP_INITIALIZER,
      useFactory: configureAuth,
      deps: [OidcConfigService, HttpClient],
      multi: true,
    },
  ],
  exports: [AuthModule],
})
export class AuthConfigModule {}
```

New

```ts
import { HttpClient } from '@angular/common/http';
import { NgModule } from '@angular/core';
import { AuthModule, StsConfigHttpLoader, StsConfigLoader } from 'angular-auth-oidc-client';
import { map } from 'rxjs/operators';

export const httpLoaderFactory = (httpClient: HttpClient) => {
  const config$ = httpClient
    .get<any>(`https://...`)
    .pipe(
      map((customConfig: any) => {
        return {
          /* your config mapping here */
        };
      })
    )
    .toPromise();

  return new StsConfigHttpLoader(config$);
};

@NgModule({
  imports: [
    AuthModule.forRoot({
      loader: {
        provide: StsConfigLoader,
        useFactory: httpLoaderFactory,
        deps: [HttpClient],
      },
    }),
  ],
  exports: [AuthModule],
})
export class AuthConfigModule {}
```

## Configuration

### `authWellknownEndpoint` renamed to `authWellknownEndpointUrl`

Old:

```ts
export interface OpenIdConfiguration {
  authWellknownEndpoint?: string;
  // ...
}
```

New:

```ts
export interface OpenIdConfiguration {
  authWellknownEndpointUrl?: string;
  // ...
}
```

### AuthWellKnownEndpoints are now part of the config

In the previous version the `AuthWellKnownEndpoints` have been a special parameter which you could pass. The type is the same but the property is now part of the configuration. The parameter to pass is in the `withConfig` method was removed.

Old:

```ts
const config = { ... };
const authWellknownEndpoints = { ... };
```

New:

```ts

const config = {
  authWellknownEndpoints: { ... }
  // other values...
};
```

### `autoUserinfo` --> `AutoUserInfo`

The casing was corrected in the config.

Old:

```ts
export interface OpenIdConfiguration {
  autoUserinfo?: boolean;
  // ...
}
```

New:

```ts
export interface OpenIdConfiguration {
  autoUserInfo?: boolean;
  // ...
}
```

### Custom Params to pass to requests have been renamed

Old:

```ts
export interface OpenIdConfiguration {
  customParams?: { [key: string]: string | number | boolean };
  customParamsRefreshToken?: { [key: string]: string | number | boolean };
  customParamsEndSession?: { [key: string]: string | number | boolean };
  customTokenParams?: { [key: string]: string | number | boolean };
  // ...
}
```

New:

```ts
export interface OpenIdConfiguration {
  customParamsAuthRequest?: { [key: string]: string | number | boolean };
  customParamsRefreshTokenRequest?: { [key: string]: string | number | boolean };
  customParamsEndSessionRequest?: { [key: string]: string | number | boolean };
  customParamsCodeRequest?: { [key: string]: string | number | boolean };
  // ...
}
```

## Service `OidcSecurityService`

### Getter for `configuration` and object `PublicConfiguration` replaced by method

The getter for the active configuration was removed as well as the object `PublicConfiguration`. As the `AuthWellKnownEndpoints` are now part of the config the property was replaced with methods to get the configuration directly. Please read below how to get the current used configuration.

Old:

```ts
export class OidcSecurityService {
  get configuration(): PublicConfiguration {}
}
```

used with

```ts
const configuration = this.oidcSecurityService.configuration;
```

New:

```ts
getConfigurations(): OpenIdConfiguration[] { }


getConfiguration(configId?: string): OpenIdConfiguration { }
```

used with

```ts
const configuration = this.oidcSecurityService.getConfiguration();
// or
const configuration = this.oidcSecurityService.getConfiguration('configId');
```

### `getToken()` renamed to `getAccessToken()`

Old

```ts
const accessToken = this.oidcSecurityService.getToken();
```

New

```ts
const accessToken = this.oidcSecurityService.getAccessToken();
```

### `checkAuth()` returning `LoginResponse` instead of boolean

The `checkAuth()` method is now not only returning if you are authenticated or not but instead a complete object containing:

```json
{
  isAuthenticated: boolean;
  userData: any;
  accessToken: string;
  idToken: string;
  configId: string;
  errorMessage?: string;
}
```

Old:

```ts
this.oidcSecurityService.checkAuth().subscribe((isAuthenticated) => {});
```

New:

```ts
this.oidcSecurityService.checkAuth().subscribe(({ isAuthenticated }) => {});
```

Or

```ts
this.oidcSecurityService.checkAuth().subscribe(({ isAuthenticated, userData, accessToken, idToken, configId }) => {
  // ...use data
});
```

### `checkAuthIncludingServer()` returning `LoginResponse` instead of boolean

See [`checkAuth()` returning `LoginResponse` instead of boolean](#checkauth-returning-loginresponse-instead-of-boolean).

Same applies for `checkAuthIncludingServer()`

### `forceRefreshSession()` returning `LoginResponse` instead of TokenResponse

See [`checkAuth()` returning `LoginResponse` instead of boolean](#checkauth-returning-loginresponse-instead-of-boolean).

Same return value applies for `forceRefreshSession()`.

Old:

```ts
this.oidcSecurityService.forceRefreshSession().subscribe((isAuthenticated) => {});
```

New:

```ts
this.oidcSecurityService.checkAuth().subscribe(({ isAuthenticated }) => {});
```

### `authorize(...)` has new `configId` as first parameter

Because multiple configs have been introduce with V12, now the `configId` is the first parameter.

Old:

```ts
const authOptions = {...}
this.oidcSecurityService.authorize(authOptions)
```

New:

```ts
const authOptions = {...}
const configIdOrNull = ./*...*/;
this.oidcSecurityService.authorize(configIdOrNull, authOptions)
```

### `logoffAndRevokeTokens(...)` has new `configId` as first parameter

Because multiple configs have been introduce with V12, now the `configId` is the first parameter.

Old:

```ts
const authOptions = {...}
this.oidcSecurityService.logoffAndRevokeTokens(authOptions)
```

New:

```ts
const authOptions = {...}
const configIdOrNull = ./*...*/;
this.oidcSecurityService.logoffAndRevokeTokens(configIdOrNull, authOptions)
```

### `logoff(...)` has new parameters

Because multiple configs have been introduce with V12, now the `configId` is the first parameter and `AuthOptions` as a second.

Old:

```ts
logoff(urlHandler?: (url: string) => any) { }
```

called with

```typescript
const urlHandler = () => {};
service.logoff(urlHandler);
```

New:

```ts
const authOptions = { urlHandler = () => {}, ...}
const configIdOrNull = ./*...*/;
this.oidcSecurityService.logoff(configIdOrNull, authOptions)
```

## Interface `AuthorizationResult` changed and renamed to `AuthenticatedResult`

The old interface `AuthorizationResult` had the following structure:

```ts
export interface AuthorizationResult {
  authorizationState: AuthorizedState;
  validationResult: ValidationResult;
  isRenewProcess: boolean;
}
```

The interface was renamed and the `authorizationState: AuthorizedState;` was converted into a `boolean` and renamed.

Old:

```ts
export interface AuthorizationResult {
  authorizationState: AuthorizedState;
  validationResult: ValidationResult;
  isRenewProcess: boolean;
}
```

```ts
this.eventService
  .registerForEvents()
  .pipe(filter((notification) => notification.type === EventTypes.NewAuthorizationResult))
  .subscribe((result: OidcClientNotification<AuthorizationResult>) => {
    console.log('isAuthenticated', result.value.authorizationState === AuthorizedState.Authorized);
  });
```

New

```ts
export interface AuthenticatedResult {
  isAuthenticated: boolean;
  validationResult: ValidationResult;
  isRenewProcess: boolean;
}
```

```typescript
this.eventService
  .registerForEvents()
  .pipe(filter((notification) => notification.type === EventTypes.NewAuthorizationResult))
  .subscribe((result: OidcClientNotification<AuthenticatedResult>) => {
    console.log('isAuthenticated', result.isAuthenticated);
  });
```
