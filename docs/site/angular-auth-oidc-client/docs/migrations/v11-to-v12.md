# Version 11 to 12

Version 12 introduces a big new feature with supporting multiple configurations and with that multiple identity provider. With that the configuration and the interface for the users changes.

We also introduced an easier way of configuring the lib from the start to align in best practices.

## Configuration

### New Param `configId`

To identify a configuration a new parameter called `configId` was introduced. This is being filled from the lib when the user does not set it explicitly in the config. If set, the configured value is taken. It is optional. For a single config this param is not really important. For multiple configs this param is important.

```ts
export interface OpenIdConfiguration {
  configId?: string;
  // ...
}
```

### `authWellknownEndpoint` renamed to `authWellknownEndpointUrl`

Old:

```ts
export interface OpenIdConfiguration {
  authWellknownEndpoint?: string;
  // ...
}
```

New:

```ts
export interface OpenIdConfiguration {
  authWellknownEndpointUrl?: string;
  // ...
}
```

### AuthWellKnownEndpoints are now part of the config

In the previous version the `AuthWellKnownEndpoints` have been a special parameter which you could pass. The type is the same but the property is now part of the configuration. The parameter to pass is in the `withConfig` method was removed.

Old:

```ts
const config = { ... };
const authWellKnown = { ... };
```

New:

```ts

const config = {
  authWellknownEndpoints: { ... }
  // other values...
};
```

### `autoUserinfo` --> `AutoUserInfo`

The casing was corrected in the config.

Old:

```ts
export interface OpenIdConfiguration {
  autoUserinfo?: boolean;
  // ...
}
```

New:

```ts
export interface OpenIdConfiguration {
  autoUserInfo?: boolean;
  // ...
}
```

### Custom Params to pass to requests have been renamed

Old:

```ts
export interface OpenIdConfiguration {
  customParams?: { [key: string]: string | number | boolean };
  customParamsRefreshToken?: { [key: string]: string | number | boolean };
  customParamsEndSession?: { [key: string]: string | number | boolean };
  customTokenParams?: { [key: string]: string | number | boolean };
  // ...
}
```

New:

```ts
export interface OpenIdConfiguration {
  customParamsAuthRequest?: { [key: string]: string | number | boolean };
  customParamsRefreshTokenRequest?: { [key: string]: string | number | boolean };
  customParamsEndSessionRequest?: { [key: string]: string | number | boolean };
  customParamsCodeRequest?: { [key: string]: string | number | boolean };
  // ...
}
```

## Interface `OidcSecurityService`

### Getter for `configuration` and object `PublicConfiguration`

```ts
@Injectable()
export class OidcSecurityService {
  /**
   * WAS REMOVED COMPLETELY
   */
  get configuration(): PublicConfiguration {  }
```

The getter for the active configuration was removed as well as the object `PublicConfiguration`. As the `AuthWellKnownEndpoints` are now part of the config the property was replaced with methods to get the configuration. Please read below how to get the current used configuration.

### `userData$` Observable return value

## Bootstrapping the lib

To make the configuration at the start easier and to be able to pass multiple configs we rewrote the bootstrapping process of the lib.

#### Old:

```ts
import { HttpClientModule } from '@angular/common/http';
import { APP_INITIALIZER, NgModule } from '@angular/core';
import { AuthModule, LogLevel, OidcConfigService } from 'angular-auth-oidc-client';
// ...

export function configureAuth(oidcConfigService: OidcConfigService) {
  return () =>
    oidcConfigService.withConfig({
      stsServer: '<your sts address here>',
      redirectUrl: window.location.origin,
      postLogoutRedirectUri: window.location.origin,
      clientId: 'angularClient',
      scope: 'openid profile email',
      responseType: 'code',
      silentRenew: true,
      silentRenewUrl: `${window.location.origin}/silent-renew.html`,
      logLevel: LogLevel.Debug,
    });
}

@NgModule({
  // ...
  imports: [
    // ...
    AuthModule.forRoot(),
  ],
  providers: [
    OidcConfigService,
    {
      provide: APP_INITIALIZER,
      useFactory: configureAuth,
      deps: [OidcConfigService],
      multi: true,
    },
  ],
  // ...
})
export class AppModule {}
```

#### New:

```typescript
import { HttpClientModule } from '@angular/common/http';
import { NgModule } from '@angular/core';
import { AuthModule, LogLevel } from 'angular-auth-oidc-client';
// ...

@NgModule({
  // ...
  imports: [
    // ...
    AuthModule.forRoot({
      config: {
        stsServer: '<your sts address here>',
        redirectUrl: window.location.origin,
        postLogoutRedirectUri: window.location.origin,
        clientId: 'angularClient',
        scope: 'openid profile email',
        responseType: 'code',
        silentRenew: true,
        silentRenewUrl: `${window.location.origin}/silent-renew.html`,
        logLevel: LogLevel.Debug,
      },
    }),
  ],
  // ...
})
export class AppModule {}
```

#### Old (with Http Loading)

```typescript
import { HttpClient } from '@angular/common/http';
import { APP_INITIALIZER, NgModule } from '@angular/core';
import { AuthModule, OidcConfigService, OidcSecurityService } from 'angular-auth-oidc-client';
import { map, switchMap } from 'rxjs/operators';

export function configureAuth(oidcConfigService: OidcConfigService, httpClient: HttpClient) {
  const setupAction$ = httpClient.get<any>(`https://...`).pipe(
    map((customConfig) => {
      return {
        stsServer: customConfig.stsServer,
        //...
      };
    }),
    switchMap((config) => oidcConfigService.withConfig(config))
  );

  return () => setupAction$.toPromise();
}

@NgModule({
  imports: [AuthModule.forRoot()],
  providers: [
    OidcSecurityService,
    OidcConfigService,
    {
      provide: APP_INITIALIZER,
      useFactory: configureAuth,
      deps: [OidcConfigService, HttpClient],
      multi: true,
    },
  ],
  exports: [AuthModule],
})
export class AuthConfigModule {}
```

#### New (with HTTP Loading)

```typescript
import { HttpClient } from '@angular/common/http';
import { NgModule } from '@angular/core';
import { AuthModule, StsConfigHttpLoader, StsConfigLoader } from 'angular-auth-oidc-client';
import { map } from 'rxjs/operators';

export const httpLoaderFactory = (httpClient: HttpClient) => {
  const config$ = httpClient
    .get<any>(`https://...`)
    .pipe(
      map((customConfig: any) => {
        return {
          stsServer: customConfig.stsServer,
          //...
        };
      })
    )
    .toPromise();

  return new StsConfigHttpLoader(config$);
};

@NgModule({
  imports: [
    AuthModule.forRoot({
      loader: {
        provide: StsConfigLoader,
        useFactory: httpLoaderFactory,
        deps: [HttpClient],
      },
    }),
  ],
  exports: [AuthModule],
})
export class AuthConfigModule {}
```

### Return type of `checkAuth()` method is now an object `LoginResponse`

In the previous version the `checkAuth` method only returned if you are authenticated or not. New the method returns the `LoginResponse` object which provides

```typescript
export interface LoginResponse {
  isAuthenticated: boolean;
  userData?: any;
  accessToken?: string;
  errorMessage?: string;
}
```

#### Old

```typescript
this.oidcSecurityService.checkAuth().subscribe((isAuthenticated) => {
  console.log('app authenticated', isAuthenticated);
});
```

#### New

```typescript
this.oidcSecurityService.checkAuth().subscribe(({ isAuthenticated }) => {
  console.log('app authenticated', isAuthenticated);
});
```

Or if you want to have all information

```typescript
this.oidcSecurityService.checkAuth().subscribe(({ isAuthenticated, userData, accessToken, errorMessage }) => {
  console.log(isAuthenticated);
  console.log(userData);
  console.log(accessToken);
  console.log(errorMessage);
});
```

### Authorization Result has been updated with breaking changes

`AuthorizationResult` has been updated to return a boolean called `isAuthenticated` instead of an `AuthorizedState` enum value called `authorizationState`

### Old

```typescript
import { Component, OnInit } from '@angular/core';
import { PublicEventsService, EventTypes, OidcClientNotification, AuthorizationResult, AuthorizedState } from 'angular-auth-oidc-client';
import { filter } from 'rxjs/operators';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.scss'],
})
export class AppComponent implements OnInit {
  title = 'AuthTest';
  constructor(private readonly eventService: PublicEventsService) {}

  ngOnInit(): void {
    this.eventService
      .registerForEvents()
      .pipe(filter((notification) => notification.type === EventTypes.NewAuthorizationResult))
      .subscribe((result: OidcClientNotification<AuthorizationResult>) => {
        console.log('NewAuthorizationResult', result);
        console.log('isAuthenticated', result.value.authorizationState === AuthorizedState.Authorized);
      });
  }
}
```

### New

```typescript
import { Component, OnInit } from '@angular/core';
import { PublicEventsService, EventTypes, OidcClientNotification, AuthorizationResult } from 'angular-auth-oidc-client';
import { filter } from 'rxjs/operators';

@Component({
  selector: 'app-root',
  templateUrl: './app.component.html',
  styleUrls: ['./app.component.scss'],
})
export class AppComponent implements OnInit {
  title = 'AuthTest';
  constructor(private readonly eventService: PublicEventsService) {}

  ngOnInit(): void {
    this.eventService
      .registerForEvents()
      .pipe(filter((notification) => notification.type === EventTypes.NewAuthorizationResult))
      .subscribe((result: OidcClientNotification<AuthorizationResult>) => {
        console.log('NewAuthorizationResult', result);
        console.log('isAuthenticated', result.value.isAuthenticated);
      });
  }
}
```

### `logoff` expects object now

The parameter to be passed into the `logoff` method is now an object with the properties `urlHandler` and `customParams` which provides you to pass custom parameters to the logoff url.

#### Old

```typescript
logoff(urlHandler?: (url: string) => any) {
  return this.logoffRevocationService.logoff(urlHandler);
}
```

called with

```typescript
const urlHandler = () => {};
service.logoff(urlHandler);
```

#### New

```typescript
logoff(authOptions?: AuthOptions) {
  const { urlHandler, customParams } = authOptions || {};
}
```

called with

```typescript
const urlHandler = () => {};
const customParams = /* */; // pass them if you want to
service.logoff({ urlHandler, customParams });
```
